---
title: "Signature Search Results"
output: 'html_document'
---

```{r, include=FALSE}
library(tidyverse)
library(kableExtra)
library(ggsignif)
```


# Class A - Gio

Read in the exported data from the GPCRdb. The data was generated by selecting the structures of these pdb ids:

- 6n4b
- 6g79
- 6d9h
- 6dde
- 6cmo
- 6os9
- 6oik

<!-- 6n4b, 6g79, 6d9h, 6dde, 6cmo, 6os9, 6oik -->

The top rows look like this:

```{r, message=FALSE, warning=FALSE}
df_raw <- read_csv('../data/a-gio-signature-search.csv')
dim(df_raw)
head(df_raw)
```

End goal of this section is to produce a bar chart that highlights the frequency of primary and secondary coupling per g-protein class. I will generate this plot from the top x% or those receptors with a score over a certain threshold. For this I need to:

1. select the columns corresponding to the merged dataset
1. rename the columns
1. sort and filter by signature match score
1. group the entries per g-protein class
1. count the members per group on a primary/secondary coupling level
1. display the groups as bar chart

```{r}
which_dataset <- 'merg'
df <- df_raw %>% 
    select(
        name,
        score,
        starts_with(which_dataset)) %>% 
    rename(
        'Gs'=paste0(which_dataset, '_gs'),
        'Gi/Go'=paste0(which_dataset, '_gio'),
        'Gq/G11'=paste0(which_dataset, '_gq11'),
        'G12/G13'=paste0(which_dataset, '_g1213')) %>% 
    gather(sigprot, coupling, -name, -score) %>% 
    # top_frac(.1, wt=score) %>%
    # filter(!is.na(coupling)) %>% 
    mutate(coupling=case_when(
      coupling == 'primary' ~ 'Primary',
      coupling == 'secondary' ~ 'Secondary',
      coupling == 'no coupling' ~ 'No Coupling',
      is.na(coupling) ~ 'No Data',
    ))

df$coupling_f = factor(df$coupling, levels=c('Primary','Secondary', 'No Coupling','No Data'))
df$sigprot_f = factor(df$sigprot, levels=c('Gs','Gi/Go', 'Gq/G11','G12/G13'))

```

```{r}
df %>% 
  group_by(coupling, sigprot) %>% 
  summarise(n = n()) %>% 
  arrange(coupling)
```

```{r}
df %>% 
  group_by(coupling) %>% 
  count()
```


```{r}
df1 <- df %>%
    group_by(sigprot, coupling) %>%
    summarise(n = n()) %>% 
    ungroup() %>% 
    group_by(coupling) %>% 
    mutate(n2 = n / sum(n)) %>% 
    arrange(coupling)

df1$coupling_f = factor(df1$coupling, levels=c('Primary','Secondary', 'No Coupling','No Data'))
df1$sigprot_f = factor(df1$sigprot, levels=c('Gs','Gi/Go', 'Gq/G11','G12/G13'))

plot <- df1 %>%  
    ggplot(aes(sigprot_f, n2)) +
      geom_col() +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      facet_grid(coupling_f ~ .) +
      # scale_y_continuous(breaks = seq(0, 20, by = 5)) +
      labs(
        x='Signal Protein Class',
        y='Number of Matches'
      )

ggsave(
  '../images/results/a-gio-search-results.pdf',
  plot,
)

plot
```

This was my first attemp at plotting how many matches i get per combination of coupling level and sigprot.
David had a while ago suggested a different way of plotting the data:

```{r}
df %>%
  filter(sigprot=='Gs') %>%
  arrange(desc(score)) %>% 
  mutate(name=factor(name, levels=name)) %>% 
  ggplot(aes(name, score)) +
    geom_bar(stat = 'identity') +
    theme_minimal() +
    facet_grid(coupling_f ~ .)
```

This is receptors on the x-axis, ordered by their score on the y-axis.
I dont think this allows for a nice comparison of the underlying distributions of the scores.
Also this necessitates a distinct plot for each sigprot.
Not ideal in this scenario.

An attempt ot make it easier to compare the distirbutions via a histogram viz:
```{r}
plot_text <- df %>% 
  group_by(sigprot, coupling) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  mutate(
    x = 80,
    y = 20,
    text = paste0('N==', n))

plot <- df %>%
    left_join(plot_text) %>% 
    ggplot(aes(score)) +
      geom_histogram(binwidth = 3) +
      # geom_histogram(aes(y = ..density..), binwidth=density(df$score)$bw) +
      # geom_density(fill="grey20", alpha = 0.2) +
      geom_text(
        aes(
          x=x,
          y=y,
          label = text),
        vjust = "inward",
        hjust = "inward",
        parse = TRUE,
        size = 8 / .pt,
        check_overlap = TRUE) +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      facet_grid(sigprot_f ~ coupling_f) +
      labs(
        x='Score',
        y='Number of Receptors per Bin'
      )

ggsave(
  '../images/results/a-gio-search-results-histo.pdf',
  plot,
  height = 5,
  width = 11
)

plot
```

Interesting to see would be if there is a significant difference in the mean score between the distributions of primary coupling and the individual signal proteins.

```{r}
plot <- df %>%
    filter(coupling=='Primary') %>% 
    ggplot(aes(sigprot_f, score)) +
      geom_boxplot() +
      geom_signif(
        comparisons = list(
          c("Gi/Go", "Gs"),
          c("Gi/Go", "Gq/G11"),
          c("Gi/Go", "G12/G13")),
        map_signif_level = TRUE,
        test = 'wilcox.test',
        textsize=4,
        y_position=c(85, 81, 89),
        vjust=0.0) +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      # facet_grid(coupling_f ~ .) +
      labs(
        x='G protein class',
        y='Score'
      ) +
      ylim(NA,90)

ggsave(
  '../images/results/a-gio-search-results-sigdiff.pdf',
  plot,
)

plot
```

```{r}
df %>% 
  filter(coupling=='Primary') %>% 
  group_by(coupling, sigprot) %>%
  summarise(median(score), sum(score), n())
```

```{r}
df %>% 
  filter(coupling=='Primary') %>% 
  group_by(coupling, sigprot) %>%
  mutate(norm_score=score/n()) %>% 
  summarise(median(norm_score), sum(norm_score), n())
```

```{r}
df_norm <- df %>% 
  group_by(coupling, sigprot) %>%
  mutate(norm_score=score/n())
df_norm
```

```{r}
plot <- df_norm %>%
    ggplot(aes(norm_score)) +
      geom_histogram() +
      # geom_histogram(aes(y = ..density..), binwidth=density(df$score)$bw) +
      # geom_density(fill="grey20", alpha = 0.2) +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      facet_grid(sigprot_f ~ coupling_f) +
      labs(
        x='Normalized Score',
        y='Number of Receptors per Bin'
      ) +
      xlim(0,2)
plot
```

```{r}
plot <- df_norm %>%
    ggplot(aes(sigprot_f, norm_score)) +
      geom_boxplot() +
      geom_signif(
        comparisons = list(
          c("Gi/Go", "Gq/G11"),
          c("Gi/Go", "G12/G13"),
          c("Gi/Go", "Gs")),
        map_signif_level = TRUE,
        textsize=6) +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      # facet_grid(coupling_f ~ .) +
      labs(
        x='G protein class',
        y='Normalized Score'
      )

plot
```


# Class B - Gs

Read in the exported data from the GPCRdb. The data was generated by selecting the structures of these pdb ids:

- 6B3J
- 6NIY
- 6NBF

The top rows look like this:

```{r, message=FALSE, warning=FALSE}
df_raw <- read_csv('../data/b1-gs-signature-search.csv')
dim(df_raw)
head(df_raw)
```

End goal of this section is to produce a bar chart that highlights the frequency of primary and secondary coupling per g-protein class. I will generate this plot from the top x% or those receptors with a score over a certain threshold. For this I need to:

1. select the columns corresponding to the merged dataset
1. rename the columns
1. sort and filter by signature match score
1. group the entries per g-protein class
1. count the members per group on a primary/secondary coupling level
1. display the groups as bar chart

```{r}
which_dataset <- 'merg'

df <- df_raw %>% 
    select(
        name,
        score,
        starts_with(which_dataset)) %>% 
    rename(
        'Gs'=paste0(which_dataset, '_gs'),
        'Gi/Go'=paste0(which_dataset, '_gio'),
        'Gq/G11'=paste0(which_dataset, '_gq11'),
        'G12/G13'=paste0(which_dataset, '_g1213')) %>% 
    gather(sigprot, coupling, -name, -score) %>% 
    # top_frac(.1, wt=score) %>%
    filter(!is.na(coupling)) %>% 
    mutate(coupling=case_when(
      coupling == 'primary' ~ 'Primary',
      coupling == 'secondary' ~ 'Secondary',
      coupling == 'no coupling' ~ 'No Coupling',
      is.na(coupling) ~ 'No Data',
    ))

df$coupling_f = factor(df$coupling, levels=c('Primary','Secondary', 'No Coupling','No Data'))
df$sigprot_f = factor(df$sigprot, levels=c('Gs','Gi/Go', 'Gq/G11','G12/G13'))

```

```{r}
df2 <- df %>%
    group_by(sigprot, coupling) %>%
    summarise(n = n()) %>% 
    ungroup() %>% 
    group_by(coupling) %>% 
    mutate(n2 = n / sum(n)) %>% 
    arrange(coupling)

df2$coupling_f = factor(df2$coupling, levels=c('Primary','Secondary', 'No Coupling','No Data'))
df2$sigprot_f = factor(df2$sigprot, levels=c('Gs','Gi/Go', 'Gq/G11','G12/G13'))

plot <- df2 %>%  
    ggplot(aes(sigprot_f, n2)) +
      geom_col() +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      facet_grid(coupling_f ~ .) +
      # scale_y_continuous(breaks = seq(0, 20, by = 5)) +
      labs(
        x='Signal Protein Class',
        y='Number of Matches'
      )
    
ggsave(
  '../images/results/b1-gs-search-results.pdf',
  plot,
)

plot
```

```{r}
plot_text <- df %>% 
  group_by(sigprot, coupling) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  mutate(
    x = 82,
    y = 4,
    text = paste0('N==', n))

plot <- df %>%
    left_join(plot_text) %>% 
    ggplot(aes(score)) +
      geom_histogram() +
      # geom_histogram(aes(y = ..density..), binwidth=density(df$score)$bw) +
      # geom_density(fill="grey20", alpha = 0.2) +
      geom_text(
        aes(
          x=x,
          y=y,
          label = text),
        vjust = "inward",
        hjust = "inward",
        parse = TRUE,
        size = 8 / .pt,
        check_overlap = TRUE) +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      facet_grid(sigprot_f ~ coupling_f) +
      labs(
        x='Score',
        y='Number of Receptors per Bin'
      )

ggsave(
  '../images/results/b1-gs-search-results-histo.pdf',
  plot,
)

plot
```


```{r}
df_raw_a <- read_csv('../data/a-gio-signature-search.csv') %>% 
    select(
        name,
        score,
        starts_with(which_dataset)) %>% 
    rename(
        'Gs'=paste0(which_dataset, '_gs'),
        'Gi/Go'=paste0(which_dataset, '_gio'),
        'Gq/G11'=paste0(which_dataset, '_gq11'),
        'G12/G13'=paste0(which_dataset, '_g1213')) %>% 
    gather(sigprot, coupling, -name, -score) %>% 
    # top_frac(.1, wt=score) %>%
    filter(!is.na(coupling)) %>% 
    mutate(coupling=case_when(
      coupling == 'primary' ~ 'Primary',
      coupling == 'secondary' ~ 'Secondary',
      coupling == 'no coupling' ~ 'No Coupling',
      is.na(coupling) ~ 'No Data'),
      class='Class A')


df_raw_b <- read_csv('../data/b1-gs-signature-search.csv') %>% 
    select(
        name,
        score,
        starts_with(which_dataset)) %>% 
    rename(
        'Gs'=paste0(which_dataset, '_gs'),
        'Gi/Go'=paste0(which_dataset, '_gio'),
        'Gq/G11'=paste0(which_dataset, '_gq11'),
        'G12/G13'=paste0(which_dataset, '_g1213')) %>% 
    gather(sigprot, coupling, -name, -score) %>% 
    filter(!is.na(coupling)) %>% 
    mutate(coupling=case_when(
      coupling == 'primary' ~ 'Primary',
      coupling == 'secondary' ~ 'Secondary',
      coupling == 'no coupling' ~ 'No Coupling',
      is.na(coupling) ~ 'No Data'),
      class='Class B1')

df <- bind_rows(df_raw_a, df_raw_b) %>% 
    group_by(class, sigprot, coupling) %>% 
    summarise(n = n()) %>% 
    group_by(class, coupling) %>% 
    mutate(
      n2 = n / sum(n),
      x = 4.2,
      y = 0.95,
      text = paste0('N==', sum(n)))
  
df$coupling_f = factor(df$coupling, levels=c('Primary','Secondary', 'No Coupling','No Data'))
df$sigprot_f = factor(df$sigprot, levels=c('Gs','Gi/Go', 'Gq/G11','G12/G13'))

plot <- df %>% 
    ggplot(aes(sigprot_f, n2)) +
      geom_col() +
        geom_text(
        aes(
          x=x,
          y=y,
          label = text),
        vjust = "inward",
        hjust = "inward",
        parse = TRUE,
        size = 8 / .pt,
        check_overlap = TRUE) +
      theme_minimal() +
      theme(panel.spacing = unit(1, "lines")) +
      scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = .25)) +
      facet_grid(
        coupling_f ~ class) +
      labs(
        x='Signal Protein Class',
        y='Number of Matches'
      )
    
ggsave(
  '../images/results/combined-search-results.pdf',
  plot,
)

plot
```

```{r}
ref_data <- read_tsv('../data/uniprot-gpcr.tsv')

caption = 'Orphan Receptor References for Class A – G$_{i/o}$ Signature Search Results; Top 10 primary G$_{i/o}$ coupling receptors, out of 18'

df_l <- read_csv('../data/a-gio-signature-search.csv') %>% 
    filter(family=='Orphan receptors') %>% 
    select(
        name,
        score,
        starts_with(which_dataset)) %>% 
    rename(
        'Gs'=paste0(which_dataset, '_gs'),
        'Gi/Go'=paste0(which_dataset, '_gio'),
        'Gq/G11'=paste0(which_dataset, '_gq11'),
        'G12/G13'=paste0(which_dataset, '_g1213')) %>% 
    gather(sigprot, coupling, -name, -score) %>% 
    filter(!is.na(coupling)) %>%
    mutate(coupling=case_when(
      coupling == 'primary' ~ 'Primary',
      coupling == 'secondary' ~ 'Secondary',
      coupling == 'no coupling' ~ 'No Coupling',
      is.na(coupling) ~ 'No Data'),
      class='Class A') %>% 
  filter(
    coupling=='Primary',
    sigprot=='Gi/Go') %>%
  arrange(desc(score)) %>%
  distinct(name, .keep_all = T)

df_r <- ref_data %>% 
  filter(str_detect(`Entry name`, paste(df_l$name, collapse = '|'))) %>% 
  mutate(
    name=str_split(`Entry name`, '_', simplify = T)[,1],
    prot=str_split(`Protein names`, '\\(', simplify = T)[,1],
    pdb=str_extract(str_extract(`Cross-reference (PDB)`, '\\w*;$'), '\\w+')
  ) %>% 
  mutate(pdb=case_when(
    is.na(pdb) ~ '\\textit{No PDB}',
    TRUE ~ pdb
  )) %>% 
  select(name, pdb, prot)

left_join(df_l, df_r, by='name') %>%
  top_n(15, score) %>% 
  select(
    'UniProt'=name,
    # 'Name'=prot,
    'Score'=score,
    'PDB References'=pdb) %>%
  knitr::kable(
    "latex",
    caption = caption,
    booktabs = T,
    linesep = "",
    label='a-gio-references',
    escape = FALSE) %>%
    kable_styling(latex_options = 'hold_position') %>%
    write(., '../data/latex_tables/a-gio-orphan-search-references.tex')
```

```{r}
ref_data <- read_tsv('../data/uniprot-gpcr.tsv')

caption = 'Receptor References for Class A – G$_{i/o}$ Signature Search Results; Top 15 primary G$_{i/o}$ coupling receptors, out of 138'

df_l <- df_raw_a %>% 
  filter(
    coupling=='Primary',
    sigprot=='Gi/Go') %>%
  arrange(desc(score)) %>%
  distinct(name, .keep_all = T)

df_r <- ref_data %>% 
  filter(str_detect(`Entry name`, paste(df_l$name, collapse = '|'))) %>% 
  mutate(
    name=str_split(`Entry name`, '_', simplify = T)[,1],
    prot=str_split(`Protein names`, '\\(', simplify = T)[,1],
    pdb=str_extract(str_extract(`Cross-reference (PDB)`, '\\w*;$'), '\\w+')
  ) %>% 
  mutate(pdb=case_when(
    is.na(pdb) ~ '\\textit{No PDB}',
    TRUE ~ pdb
  )) %>% 
  select(name, pdb, prot)

left_join(df_l, df_r, by='name') %>%
  top_n(15, score) %>% 
  select(
    'UniProt'=name,
    # 'Name'=prot,
    'Score'=score,
    'PDB References'=pdb) %>%
  knitr::kable(
    "latex",
    caption = caption,
    booktabs = T,
    linesep = "",
    label='a-gio-references',
    escape = FALSE) %>%
    kable_styling(latex_options = 'hold_position') %>%
    write(., '../data/latex_tables/a-gio-search-references.tex')
```
```{r}
ref_data <- read_tsv('../data/uniprot-gpcr.tsv')

caption = 'Receptor References for Class B1 – G$_{s}$ Signature Search Results; all primary G$_{s}$ coupling receptors'

df_l <- df_raw_b %>% 
  filter(
    coupling=='Primary',
    sigprot=='Gs') %>%
  arrange(desc(score)) %>%
  distinct(name, .keep_all = T)

df_r <- ref_data %>% 
  filter(str_detect(`Entry name`, paste(df_l$name, collapse = '|'))) %>% 
  mutate(
    name=str_split(`Entry name`, '_', simplify = T)[,1],
    prot=str_split(`Protein names`, '\\(', simplify = T)[,1],
    pdb=str_extract(str_extract(`Cross-reference (PDB)`, '\\w*;$'), '\\w+')
  ) %>% 
  mutate(pdb=case_when(
    is.na(pdb) ~ '\\textit{No PDB}',
    TRUE ~ pdb
  )) %>% 
  select(name, pdb, prot)

left_join(df_l, df_r, by='name') %>%
  select(
    'UniProt'=name,
    # 'Name'=prot,
    'Score'=score,
    'PDB References'=pdb) %>%
  knitr::kable(
    "latex",
    caption = caption,
    booktabs = T,
    linesep = "",
    label = 'b1-gs-references',
    escape = FALSE) %>%
    kable_styling(latex_options = 'hold_position') %>%
    write(., '../data/latex_tables/b1-gs-search-references.tex')
```

```{r}
caption = 'Signature Search Results for Class A – G$_{i/o}$'

read_csv('../data/a-gio-signature-search.csv') %>% 
    select(
        name,
        score,
        starts_with(which_dataset)) %>% 
    rename(
        'Gs'=paste0(which_dataset, '_gs'),
        'Gi/Go'=paste0(which_dataset, '_gio'),
        'Gq/G11'=paste0(which_dataset, '_gq11'),
        'G12/G13'=paste0(which_dataset, '_g1213')) %>% 
  arrange(desc(score)) %>% 
  knitr::kable(
    "latex",
    caption = caption,
    booktabs = T,
    longtable = T) %>%
  kable_styling(latex_options = c("hold_position", "repeat_header")) %>% 
  write(., '../data/latex_tables/appendix-a-gio-search-results.tex')


caption = 'Signature Search Results for Class B1 – G$_{s}$'

read_csv('../data/b1-gs-signature-search.csv') %>% 
    select(
        name,
        score,
        starts_with(which_dataset)) %>% 
    rename(
        'Gs'=paste0(which_dataset, '_gs'),
        'Gi/Go'=paste0(which_dataset, '_gio'),
        'Gq/G11'=paste0(which_dataset, '_gq11'),
        'G12/G13'=paste0(which_dataset, '_g1213')) %>% 
  arrange(desc(score)) %>% 
  knitr::kable(
    "latex",
    caption = caption,
    booktabs = T,
    linesep = "") %>% 
  kable_styling(latex_options = c("hold_position", "repeat_header")) %>%
  write(., '../data/latex_tables/appendix-b1-gs-search-results.tex')
```

